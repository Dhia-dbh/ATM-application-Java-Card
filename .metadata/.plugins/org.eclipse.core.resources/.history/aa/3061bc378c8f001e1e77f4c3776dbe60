package Front;
import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.IOException;
import java.net.Socket;


import com.sun.javacard.apduio.Apdu;
import com.sun.javacard.apduio.CadT1Client;
import com.sun.javacard.apduio.CadTransportException;

public class BankFunction {
	
	private final static byte INS_INITIALISER_COMPTE = (byte) 0x04;
    static Apdu apdu ;
    static CadT1Client cad;
    static int balance = 30000;

    public Apdu Msg(byte ins, byte lc, byte[] data,byte le) throws IOException, CadTransportException{
        apdu = new Apdu();
        apdu.command[Apdu.CLA] = (byte) 0xB0;
        apdu.command[Apdu.P1] = 0x00;
        apdu.command[Apdu.P2] = 0x00;
        apdu.command[Apdu.INS] = ins;
        //apdu.setLe(0x7f);
        apdu.setLe(le);
        if (data!=null)
            apdu.setDataIn(data);
        cad.exchangeApdu(apdu);
        return apdu;
    }

    
    void updateBalance() throws IOException, CadTransportException {
    	Apdu apdu = null;
    	byte[] data = new byte[3];
    	int temp = balance;
    	int a_b, a, b;
    	byte rest;
    	rest = (byte) ((byte) temp % 127);
    	a_b = (temp - rest) / 127;
    	if(a_b > 127) {
    		a = 127;
    		b = 255 - 127;
    	}
    	else {
    		a = a_b;
    		b = 0;
    	}
    	data[0] = rest;
    	data[1] = (byte) b;
    	data[2] = (byte) a;
    	apdu = Msg(INS_INITIALISER_COMPTE, (byte) 0x03, data, (byte) 0x7F);
    }
    public void Connect(){
        Socket sckCarte;

        try {
            sckCarte = new Socket("localhost", 9025);
            sckCarte.setTcpNoDelay(true);
            BufferedInputStream input = new BufferedInputStream(sckCarte.getInputStream());
            BufferedOutputStream output = new BufferedOutputStream(sckCarte.getOutputStream());
            cad = new CadT1Client(input, output);
        } catch (Exception e) {
            System.out.println("Erreur : impossible de se connecter a la Javacard");
            return;
        }
        /* Mise sous tension de la carte */
        try {
            cad.powerUp();
        } catch (Exception e) {
            System.out.println("Erreur lors de l'envoi de la commande Powerup a la Javacard");
            return;
        }
    }

    public void select() throws IOException, CadTransportException{

        /* Sélection de l'applet :création du commande SELECT APDU */
        apdu = new Apdu();
        apdu.command[Apdu.CLA] = (byte) 0x00;
        apdu.command[Apdu.INS] = (byte) 0xA4;
        apdu.command[Apdu.P1] = 0x04;
        apdu.command[Apdu.P2] = 0x00;
        byte[] appletAID = { 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x00, 0x00 };
        apdu.setDataIn(appletAID);
        cad.exchangeApdu(apdu);
        if (apdu.getStatus() != 0x9000) {
            System.out.println("Erreur lors de la sélection de l'applet");
            System.exit(1);
        }

    }

    public void Deselect(){
        /* Mise hors tension de la carte */
        try {
            cad.powerDown();
        } catch (Exception e) {
            System.out.println("Erreur lors de l'envoi de la commande Powerdown a la Javacard");
            return;
        }
    }

}
